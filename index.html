<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Color Table Creator</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
/*
Creative Commons Attribution-NonCommercial 4.0 International (CC BY-NC 4.0) 

Copyright (c) 2024-2025 Garrett Helms

Permission is hereby granted, free of charge, to any person obtaining a copy of this software and associated documentation files (the "Software"), to use, copy, and modify the Software, provided that the following conditions are met:

1. **Non-Commercial Use Only**: The Software may be used only for non-commercial purposes. Redistribution, sublicensing, and/or modification of this Software for commercial gain is strictly prohibited.

2. **Attribution and Integrity**: The name "Garrett Helms," aliases including "Garrett H.," must not be removed from this notice, any part of the Software, its documentation, or the Software's user interface. This includes social media links added for the author's profiles, which must remain in the footer as-is, unaltered. All copies, modifications, or substantial portions of the Software must include this copyright notice and attribution.

3. **No Removal of Identifiers**: Alteration or removal of the author's name, aliases, associated identifiers, or social media links is strictly prohibited in any copies, forks, redistributions, or modified versions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE, AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES, OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT, OR OTHERWISE, ARISING FROM, OUT OF, OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.

Author: Garrett Helms
*/

/* ‚îÄ‚îÄ Theme Variables ‚îÄ‚îÄ */
:root {
  --bg-page: #f0f2f5;
  --bg-card: #ffffff;
  --bg-input: #f8f9fb;
  --bg-hover: #f3f4f8;
  --text-primary: #1e1e2e;
  --text-secondary: #555570;
  --text-muted: #9090a8;
  --border: #e2e4ea;
  --border-focus: #6366f1;
  --accent: #6366f1;
  --accent-hover: #4f46e5;
  --accent-subtle: #eef2ff;
  --success: #10b981;
  --success-hover: #059669;
  --danger: #ef4444;
  --danger-hover: #dc2626;
  --warning: #f59e0b;
  --warning-hover: #d97706;
  --shadow-sm: 0 1px 3px rgba(0,0,0,0.06), 0 1px 2px rgba(0,0,0,0.04);
  --shadow-md: 0 4px 6px -1px rgba(0,0,0,0.07), 0 2px 4px -2px rgba(0,0,0,0.04);
  --shadow-lg: 0 10px 20px -4px rgba(0,0,0,0.1), 0 4px 6px -4px rgba(0,0,0,0.06);
  --radius-sm: 6px;
  --radius-md: 10px;
  --radius-lg: 14px;
  --font: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
}

body.dark-mode {
  --bg-page: #0d0d14;
  --bg-card: #1a1a28;
  --bg-input: #222234;
  --bg-hover: #252540;
  --text-primary: #e8e8f0;
  --text-secondary: #a0a0b8;
  --text-muted: #606078;
  --border: #2a2a40;
  --accent: #818cf8;
  --accent-hover: #6366f1;
  --accent-subtle: #1e1e3a;
  --shadow-sm: 0 1px 3px rgba(0,0,0,0.3);
  --shadow-md: 0 4px 6px rgba(0,0,0,0.3);
  --shadow-lg: 0 10px 20px rgba(0,0,0,0.4);
}

/* ‚îÄ‚îÄ Reset & Base ‚îÄ‚îÄ */
*, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

body {
  font-family: var(--font);
  background: var(--bg-page);
  color: var(--text-primary);
  line-height: 1.5;
  min-height: 100vh;
}

/* ‚îÄ‚îÄ App Header ‚îÄ‚îÄ */
.app-header {
  background: var(--bg-card);
  border-bottom: 1px solid var(--border);
  padding: 14px 28px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  position: sticky;
  top: 0;
  z-index: 100;
  box-shadow: var(--shadow-sm);
}
.app-header h1 {
  font-size: 1.35rem;
  font-weight: 700;
  background: linear-gradient(135deg, var(--accent), #a855f7);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}
.header-actions { display: flex; align-items: center; gap: 8px; }

/* ‚îÄ‚îÄ Theme Toggle ‚îÄ‚îÄ */
.theme-toggle {
  background: var(--bg-input);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  padding: 7px 14px;
  cursor: pointer;
  color: var(--text-secondary);
  font-size: 0.82rem;
  font-family: var(--font);
  display: flex;
  align-items: center;
  gap: 6px;
  transition: all 0.2s;
}
.theme-toggle:hover { border-color: var(--accent); color: var(--accent); }

/* ‚îÄ‚îÄ Main Layout ‚îÄ‚îÄ */
.main-container {
  max-width: 1300px;
  margin: 0 auto;
  padding: 24px;
  display: grid;
  grid-template-columns: 1fr;
  gap: 20px;
}

/* ‚îÄ‚îÄ Cards ‚îÄ‚îÄ */
.card {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  box-shadow: var(--shadow-sm);
  overflow: hidden;
}
.card-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 14px 20px;
  border-bottom: 1px solid var(--border);
  cursor: pointer;
  user-select: none;
  transition: background 0.15s;
}
.card-header:hover { background: var(--bg-hover); }
.card-header h2 {
  font-size: 0.95rem;
  font-weight: 600;
  display: flex;
  align-items: center;
  gap: 8px;
}
.toggle-icon {
  transition: transform 0.25s;
  color: var(--text-muted);
  font-size: 0.75rem;
}
.toggle-icon.collapsed { transform: rotate(-90deg); }
.card-body { padding: 20px; }
.card-body.collapsed { display: none; }

/* ‚îÄ‚îÄ Settings Grid ‚îÄ‚îÄ */
.settings-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
  gap: 16px;
}
.form-field { display: flex; flex-direction: column; gap: 5px; }
.form-field label {
  font-size: 0.75rem;
  font-weight: 600;
  color: var(--text-muted);
  text-transform: uppercase;
  letter-spacing: 0.04em;
}
.form-field input,
.form-field select {
  padding: 8px 12px;
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  background: var(--bg-input);
  color: var(--text-primary);
  font-size: 0.88rem;
  font-family: var(--font);
  transition: all 0.2s;
  outline: none;
}
.form-field input:focus,
.form-field select:focus {
  border-color: var(--accent);
  box-shadow: 0 0 0 3px var(--accent-subtle);
}
.form-field input[type="color"] {
  padding: 3px;
  height: 38px;
  cursor: pointer;
}

/* ‚îÄ‚îÄ Buttons ‚îÄ‚îÄ */
.btn {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 8px 16px;
  border: none;
  border-radius: var(--radius-sm);
  font-family: var(--font);
  font-size: 0.82rem;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.2s;
  white-space: nowrap;
}
.btn:active { transform: scale(0.97); }
.btn-primary { background: var(--accent); color: #fff; }
.btn-primary:hover { background: var(--accent-hover); box-shadow: var(--shadow-md); }
.btn-success { background: var(--success); color: #fff; }
.btn-success:hover { background: var(--success-hover); }
.btn-danger { background: var(--danger); color: #fff; }
.btn-danger:hover { background: var(--danger-hover); }
.btn-warning { background: var(--warning); color: #fff; }
.btn-warning:hover { background: var(--warning-hover); }
.btn-ghost {
  background: transparent;
  color: var(--text-secondary);
  border: 1px solid var(--border);
}
.btn-ghost:hover { background: var(--bg-hover); border-color: var(--accent); color: var(--accent); }
.btn-sm { padding: 5px 10px; font-size: 0.78rem; }
.btn-icon {
  padding: 5px;
  width: 30px;
  height: 30px;
  justify-content: center;
  border-radius: var(--radius-sm);
  font-size: 0.9rem;
}

/* ‚îÄ‚îÄ Entries Toolbar ‚îÄ‚îÄ */
.entries-toolbar {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 12px 20px;
  border-bottom: 1px solid var(--border);
  background: var(--bg-input);
  flex-wrap: wrap;
}
.entries-count {
  margin-left: auto;
  font-size: 0.78rem;
  color: var(--text-muted);
  font-weight: 500;
}

/* ‚îÄ‚îÄ Color Entry Cards ‚îÄ‚îÄ */
.entries-container {
  max-height: 520px;
  overflow-y: auto;
  padding: 8px 12px;
}
.entries-container::-webkit-scrollbar { width: 5px; }
.entries-container::-webkit-scrollbar-track { background: transparent; }
.entries-container::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
.entries-container::-webkit-scrollbar-thumb:hover { background: var(--text-muted); }

.entries-empty {
  text-align: center;
  padding: 48px 20px;
  color: var(--text-muted);
}
.entries-empty .empty-icon { font-size: 2.5rem; margin-bottom: 12px; }
.entries-empty p { font-size: 0.9rem; }

.color-entry {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 10px 14px;
  margin: 3px 0;
  border-radius: var(--radius-md);
  border: 2px solid transparent;
  background: var(--bg-card);
  transition: all 0.15s;
  position: relative;
  animation: entrySlideIn 0.3s ease-out;
}
.color-entry:hover {
  background: var(--bg-hover);
  border-color: var(--border);
}
.color-entry.dragging { opacity: 0.35; }
.color-entry.drag-over-top { border-top-color: var(--accent); }
.color-entry.drag-over-bottom { border-bottom-color: var(--accent); }

.drag-handle {
  cursor: grab;
  color: var(--text-muted);
  font-size: 1rem;
  padding: 4px 2px;
  display: flex;
  align-items: center;
  user-select: none;
  flex-shrink: 0;
  opacity: 0.5;
  transition: opacity 0.15s;
}
.color-entry:hover .drag-handle { opacity: 1; }
.drag-handle:active { cursor: grabbing; }

.entry-color-bar {
  width: 5px;
  height: 36px;
  border-radius: 3px;
  flex-shrink: 0;
}

.entry-info {
  flex: 1;
  display: flex;
  align-items: center;
  gap: 12px;
  flex-wrap: wrap;
  min-width: 0;
}
.entry-type-badge {
  font-size: 0.68rem;
  font-weight: 600;
  text-transform: uppercase;
  padding: 2px 8px;
  border-radius: 4px;
  background: var(--accent-subtle);
  color: var(--accent);
  letter-spacing: 0.03em;
  flex-shrink: 0;
}
.entry-field {
  display: flex;
  align-items: center;
  gap: 4px;
}
.entry-field label {
  font-size: 0.72rem;
  color: var(--text-muted);
  font-weight: 500;
}
.entry-field input[type="number"] {
  width: 72px;
  padding: 4px 8px;
  border: 1px solid var(--border);
  border-radius: 4px;
  background: var(--bg-input);
  color: var(--text-primary);
  font-size: 0.82rem;
  font-family: var(--font);
  text-align: center;
  outline: none;
  transition: all 0.2s;
}
.entry-field input[type="number"]:focus {
  border-color: var(--accent);
  box-shadow: 0 0 0 2px var(--accent-subtle);
}
.entry-field input[type="color"] {
  width: 30px;
  height: 30px;
  border: 2px solid var(--border);
  border-radius: 6px;
  padding: 2px;
  cursor: pointer;
  transition: border-color 0.2s;
}
.entry-field input[type="color"]:hover { border-color: var(--accent); }
.entry-gradient-preview {
  width: 60px;
  height: 20px;
  border-radius: 4px;
  border: 1px solid var(--border);
  flex-shrink: 0;
}

.entry-actions {
  display: flex;
  gap: 3px;
  flex-shrink: 0;
  opacity: 0;
  transition: opacity 0.15s;
}
.color-entry:hover .entry-actions { opacity: 1; }

/* ‚îÄ‚îÄ Slide-In Entry Form Panel ‚îÄ‚îÄ */
.form-overlay {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.25);
  z-index: 200;
  opacity: 0;
  transition: opacity 0.25s;
}
.form-overlay.visible { opacity: 1; }

.form-panel {
  position: fixed;
  right: 0;
  top: 0;
  bottom: 0;
  width: 380px;
  max-width: 92vw;
  background: var(--bg-card);
  border-left: 1px solid var(--border);
  box-shadow: var(--shadow-lg);
  z-index: 201;
  display: flex;
  flex-direction: column;
  transform: translateX(100%);
  transition: transform 0.3s cubic-bezier(0.32, 0.72, 0, 1);
}
.form-panel.open { transform: translateX(0); }

.form-panel-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 18px 24px;
  border-bottom: 1px solid var(--border);
}
.form-panel-header h2 { font-size: 1.05rem; font-weight: 600; }
.form-panel-body {
  flex: 1;
  padding: 24px;
  display: flex;
  flex-direction: column;
  gap: 18px;
  overflow-y: auto;
}
.form-panel-footer {
  padding: 16px 24px;
  border-top: 1px solid var(--border);
  display: flex;
  gap: 8px;
  justify-content: flex-end;
}

/* ‚îÄ‚îÄ Preview ‚îÄ‚îÄ */
.preview-wrapper { padding: 16px 20px 20px; }
.preview-canvas {
  width: 100%;
  height: 70px;
  border-radius: var(--radius-md);
  border: 1px solid var(--border);
  cursor: pointer;
  transition: box-shadow 0.2s;
}
.preview-canvas:hover { box-shadow: var(--shadow-md); }
.preview-markers {
  position: relative;
  height: 22px;
  margin-top: 4px;
}
.marker {
  position: absolute;
  font-size: 0.68rem;
  color: var(--text-muted);
  transform: translateX(-50%);
  white-space: nowrap;
  font-weight: 500;
}

/* ‚îÄ‚îÄ Action Bar ‚îÄ‚îÄ */
.action-bar {
  display: flex;
  gap: 8px;
  padding: 14px 20px;
  border-top: 1px solid var(--border);
  background: var(--bg-input);
  flex-wrap: wrap;
}

/* ‚îÄ‚îÄ Toast Notifications ‚îÄ‚îÄ */
.toast-container {
  position: fixed;
  bottom: 24px;
  right: 24px;
  z-index: 1000;
  display: flex;
  flex-direction: column;
  gap: 8px;
  pointer-events: none;
}
.toast {
  padding: 12px 20px;
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--radius-md);
  box-shadow: var(--shadow-lg);
  font-size: 0.85rem;
  font-family: var(--font);
  color: var(--text-primary);
  animation: toastIn 0.3s ease-out;
  pointer-events: auto;
  display: flex;
  align-items: center;
  gap: 8px;
}
.toast.success { border-left: 4px solid var(--success); }
.toast.error { border-left: 4px solid var(--danger); }
.toast.info { border-left: 4px solid var(--accent); }
.toast.fade-out { animation: toastOut 0.3s forwards; }

/* ‚îÄ‚îÄ Footer ‚îÄ‚îÄ */
.app-footer {
  text-align: center;
  padding: 32px 24px;
  color: var(--text-muted);
  font-size: 0.85rem;
}
.social-icons {
  margin-top: 15px;
  display: flex;
  justify-content: center;
  gap: 20px;
}
.social-icons a {
  display: inline-block;
  width: 32px;
  height: 32px;
  transition: transform 0.2s, opacity 0.2s;
}
.social-icons a svg {
  width: 100%;
  height: 100%;
  fill: currentColor;
}
.social-icons a:hover {
  transform: scale(1.1);
  opacity: 0.8;
}

/* ‚îÄ‚îÄ Animations ‚îÄ‚îÄ */
@keyframes entrySlideIn {
  from { opacity: 0; transform: translateX(-10px); }
  to { opacity: 1; transform: translateX(0); }
}
@keyframes toastIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}
@keyframes toastOut {
  from { opacity: 1; transform: translateY(0); }
  to { opacity: 0; transform: translateY(10px); }
}
@keyframes highlightPulse {
  0% { background: var(--accent-subtle); border-color: var(--accent); }
  100% { background: var(--bg-card); border-color: transparent; }
}
.highlight-entry { animation: highlightPulse 1.2s ease-out; }

/* ‚îÄ‚îÄ Responsive ‚îÄ‚îÄ */
@media (max-width: 768px) {
  .main-container { padding: 12px; gap: 14px; }
  .settings-grid { grid-template-columns: 1fr 1fr; }
  .entry-info { gap: 8px; }
  .form-panel { width: 100%; }
  .app-header { padding: 12px 16px; }
  .app-header h1 { font-size: 1.1rem; }
  .entry-actions { opacity: 1; }
}
@media (max-width: 480px) {
  .settings-grid { grid-template-columns: 1fr; }
  .color-entry { flex-wrap: wrap; padding: 10px; }
  .entries-toolbar { padding: 10px 14px; }
}
  </style>
</head>
<body>

<!-- App Header -->
<header class="app-header">
  <h1>Color Table Creator</h1>
  <div class="header-actions">
    <button class="theme-toggle" id="darkModeToggle" onclick="toggleDarkMode()">
      <span id="themeIcon">üåô</span> <span id="themeLabel">Dark</span>
    </button>
  </div>
</header>

<main class="main-container">

  <!-- Settings Card -->
  <div class="card" id="settingsCard">
    <div class="card-header" onclick="toggleSection('settings')">
      <h2>‚öôÔ∏è Settings</h2>
      <span class="toggle-icon" id="settingsToggle">‚ñæ</span>
    </div>
    <div class="card-body" id="settingsBody">
      <div class="settings-grid">
        <div class="form-field">
          <label for="product">Product</label>
          <input type="text" id="product" placeholder="e.g. Reflectivity">
        </div>
        <div class="form-field">
          <label for="units">Units</label>
          <input type="text" id="units" placeholder="e.g. dBZ">
        </div>
        <div class="form-field">
          <label for="scale">Scale</label>
          <input type="number" id="scale" step="0.01" placeholder="e.g. 1.0">
        </div>
        <div class="form-field">
          <label for="offset">Offset</label>
          <input type="number" id="offset" step="0.01" placeholder="e.g. 0.0">
        </div>
        <div class="form-field">
          <label for="step">Step</label>
          <input type="number" id="step" step="0.01" placeholder="e.g. 5.0">
        </div>
        <div class="form-field">
          <label for="rfColor">RF Color</label>
          <input type="color" id="rfColor" value="#404040">
        </div>
        <div class="form-field">
          <label for="filename">Filename</label>
          <input type="text" id="filename" placeholder="color_table.pal" value="color_table.pal">
        </div>
      </div>
    </div>
  </div>

  <!-- Entries Card -->
  <div class="card">
    <div class="entries-toolbar">
      <button class="btn btn-primary" onclick="openAddForm()">Ôºã Add Color</button>
      <button class="btn btn-ghost btn-sm" onclick="sortEntries()">‚Üï Sort by Value</button>
      <span class="entries-count" id="entriesCount">0 entries</span>
    </div>
    <div class="entries-container" id="entriesContainer">
      <div class="entries-empty" id="emptyState">
        <div class="empty-icon">üé®</div>
        <p>No color entries yet.<br>Click <strong>Add Color</strong> to get started, or <strong>Load</strong> an existing file.</p>
      </div>
    </div>
    <div class="action-bar">
      <button class="btn btn-primary" onclick="saveColorTable()">üíæ Save Table</button>
      <button class="btn btn-warning" onclick="loadColorTable()">üìÇ Load File</button>
      <button class="btn btn-ghost" onclick="undo()">‚Ü© Undo</button>
    </div>
  </div>

  <!-- Preview Card -->
  <div class="card">
    <div class="card-header" onclick="toggleSection('preview')">
      <h2>üé® Preview</h2>
      <span class="toggle-icon" id="previewToggle">‚ñæ</span>
    </div>
    <div class="preview-wrapper" id="previewBody">
      <canvas id="previewCanvas" class="preview-canvas"></canvas>
      <div class="preview-markers" id="markersContainer"></div>
    </div>
  </div>

</main>

<!-- Slide-in Entry Form -->
<div class="form-overlay" id="formOverlay" onclick="cancelEdit()"></div>
<div class="form-panel" id="formPanel">
  <div class="form-panel-header">
    <h2 id="formTitle">Add Color Entry</h2>
    <button class="btn btn-icon btn-ghost" onclick="cancelEdit()" title="Close">‚úï</button>
  </div>
  <div class="form-panel-body">
    <div class="form-field">
      <label for="entryType">Type</label>
      <select id="entryType" onchange="toggleEntryFields()">
        <option value="SolidColor">SolidColor</option>
        <option value="SolidColor4">SolidColor4 (with alpha)</option>
        <option value="Color">Color (gradient)</option>
        <option value="Color4">Color4 (gradient + alpha)</option>
      </select>
    </div>
    <div class="form-field">
      <label for="entryValue">Value</label>
      <input type="number" id="entryValue" step="1" placeholder="Enter value">
    </div>
    <div class="form-field">
      <label for="startColor">Start Color</label>
      <input type="color" id="startColor" value="#ffffff">
    </div>
    <div class="form-field" id="startAlphaGroup" style="display:none">
      <label for="startAlpha">Start Alpha (0‚Äì1)</label>
      <input type="number" id="startAlpha" step="0.01" min="0" max="1" value="1">
    </div>
    <div class="form-field" id="endColorGroup" style="display:none">
      <label for="endColor">End Color</label>
      <input type="color" id="endColor" value="#ffffff">
    </div>
    <div class="form-field" id="endAlphaGroup" style="display:none">
      <label for="endAlpha">End Alpha (0‚Äì1)</label>
      <input type="number" id="endAlpha" step="0.01" min="0" max="1" value="1">
    </div>
  </div>
  <div class="form-panel-footer">
    <button class="btn btn-ghost" onclick="cancelEdit()">Cancel</button>
    <button class="btn btn-primary" onclick="saveEntry()">Save Entry</button>
  </div>
</div>

<!-- Toast Container -->
<div class="toast-container" id="toastContainer"></div>

<!-- Footer with Social Media Icons -->
<div class="app-footer">
  &copy; 2024-2025 Garrett Helms. All rights reserved.
  <div class="social-icons">
    <a href="https://x.com/WxGareBear" target="_blank" aria-label="Twitter/X">
      <!-- Twitter/X SVG Icon -->
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="#1DA1F2">
        <path d="M23.954 4.569c-.885.392-1.83.656-2.825.775 
          1.014-.609 1.794-1.574 2.163-2.723
          -.95.555-2.005.959-3.127 1.184
          -.897-.957-2.178-1.555-3.594-1.555
          -2.717 0-4.92 2.203-4.92 4.917 
          0 .39.045.765.127 1.124 
          -4.087-.205-7.713-2.164-10.141-5.144 
          -.424.722-.666 1.561-.666 2.475 
          0 1.708.87 3.213 2.188 4.096 
          -.807-.026-1.566-.248-2.228-.616 
          v.061c0 2.385 1.693 4.374 3.946 4.827 
          -.413.111-.849.171-1.296.171 
          -.314 0-.615-.03-.916-.086 
          .631 1.953 2.445 3.377 4.6 3.419 
          -1.68 1.319-3.809 2.105-6.102 2.105 
          -.39 0-.779-.023-1.17-.067 
          2.179 1.397 4.768 2.213 7.557 2.213 
          9.054 0 14-7.496 14-13.986 
          0-.21 0-.423-.015-.637 
          .961-.689 1.8-1.56 2.46-2.548 
          l-.047-.02z"/>
      </svg>
    </a>
    <a href="https://github.com/garrett-wx" target="_blank" aria-label="GitHub">
      <!-- GitHub SVG Icon -->
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="#333">
        <path d="M12 .5C5.73.5.5 5.73.5 12 
          c0 5.08 3.29 9.4 7.86 10.94 
          .58.11.79-.25.79-.56 
          0-.28-.01-1.02-.02-2 
          -3.2.7-3.88-1.54-3.88-1.54 
          -.53-1.35-1.3-1.71-1.3-1.71 
          -1.06-.73.08-.72.08-.72 
          1.17.08 1.79 1.2 1.79 1.2 
          1.04 1.78 2.73 1.27 3.4.97 
          .11-.75.41-1.27.75-1.56 
          -2.55-.29-5.23-1.28-5.23-5.7 
          0-1.26.45-2.29 1.19-3.1 
          -.12-.29-.52-1.46.11-3.04 
          0 0 .97-.31 3.18 1.18 
          a11.04 11.04 0 012.9-.39 
          c.98 0 1.96.13 2.9.39 
          2.2-1.49 3.17-1.18 3.17-1.18 
          .63 1.58.23 2.75.11 3.04 
          .75.81 1.19 1.84 1.19 3.1 
          0 4.43-2.68 5.4-5.24 5.68 
          .42.36.8 1.08.8 2.19 
          0 1.58-.01 2.86-.01 3.25 
          0 .31.21.68.8.56 
          A11.52 11.52 0 0023.5 12 
          c0-6.27-5.23-11.5-11.5-11.5z"/>
      </svg>
    </a>
    <a href="https://instagram.com/garrett.helms05" target="_blank" aria-label="Instagram">
      <!-- Instagram SVG Icon -->
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="#E1306C">
        <path d="M12 2.163c3.204 0 3.584.012 4.85.07 
          1.366.062 2.633.344 3.608 1.32 
          .975.976 1.258 2.242 1.32 3.608 
          .058 1.266.07 1.646.07 4.85 
          s-.012 3.584-.07 4.85 
          c-.062 1.366-.344 2.633-1.32 3.608 
          -.976.975-2.242 1.258-3.608 1.32 
          -1.266.058-1.646.07-4.85.07 
          s-3.584-.012-4.85-.07 
          c-1.366-.062-2.633-.344-3.608-1.32 
          -.975-.976-1.258-2.242-1.32-3.608 
          C2.175 15.747 2.163 15.367 2.163 12 
          s.012-3.584.07-4.85 
          c.062-1.366.344-2.633 1.32-3.608 
          .976-.975 2.242-1.258 3.608-1.32 
          C8.416 2.175 8.796 2.163 12 2.163 
          zm0-2.163C8.741 0 8.332.013 7.052.072 
          5.771.13 4.667.375 3.723 1.319 
          c-.944.944-1.19 2.048-1.248 3.329 
          C2.013 5.668 2 6.077 2 9.333 
          v5.334c0 3.256.013 3.665.072 4.945 
          .058 1.281.304 2.385 1.248 3.329 
          .944.944 2.048 1.19 3.329 1.248 
          1.28.059 1.689.072 4.945.072 
          s3.665-.013 4.945-.072 
          c1.281-.058 2.385-.304 3.329-1.248 
          .944-.944 1.19-2.048 1.248-3.329 
          .059-1.28.072-1.689.072-4.945 
          V9.333c0-3.256-.013-3.665-.072-4.945 
          -.058-1.281-.304-2.385-1.248-3.329 
          -.944-.944-2.048-1.19-3.329-1.248 
          C15.665.013 15.256 0 12 0 
          zm0 5.838a6.162 6.162 0 100 12.324 
          6.162 6.162 0 000-12.324 
          zm0 10.162a3.999 3.999 0 110-7.998 
          3.999 3.999 0 010 7.998 
          zm6.406-11.845a1.44 1.44 0 11-2.88 0 
          1.44 1.44 0 012.88 0z"/>
      </svg>
    </a>
  </div>
</div>

<script>
  // ‚îÄ‚îÄ State ‚îÄ‚îÄ
  let colorEntries = [];
  let editingEntryId = null;
  let undoStack = [];
  let draggedEntryId = null;
  let isDarkMode = false;

  // ‚îÄ‚îÄ Toast Notifications ‚îÄ‚îÄ
  function showToast(message, type = 'info') {
    const container = document.getElementById('toastContainer');
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    toast.textContent = message;
    container.appendChild(toast);
    setTimeout(() => {
      toast.classList.add('fade-out');
      toast.addEventListener('animationend', () => toast.remove());
    }, 2500);
  }

  // ‚îÄ‚îÄ Section Toggle ‚îÄ‚îÄ
  function toggleSection(section) {
    const body = document.getElementById(section + 'Body');
    const icon = document.getElementById(section + 'Toggle');
    if (body.classList.contains('collapsed')) {
      body.classList.remove('collapsed');
      icon.classList.remove('collapsed');
    } else {
      body.classList.add('collapsed');
      icon.classList.add('collapsed');
    }
  }

  // ‚îÄ‚îÄ Dark Mode ‚îÄ‚îÄ
  function toggleDarkMode() {
    isDarkMode = !isDarkMode;
    document.body.classList.toggle('dark-mode', isDarkMode);
    document.getElementById('themeIcon').textContent = isDarkMode ? '‚òÄÔ∏è' : 'üåô';
    document.getElementById('themeLabel').textContent = isDarkMode ? 'Light' : 'Dark';
  }

  // ‚îÄ‚îÄ Entry Form ‚îÄ‚îÄ
  function openFormPanel() {
    const overlay = document.getElementById('formOverlay');
    const panel = document.getElementById('formPanel');
    overlay.style.display = 'block';
    requestAnimationFrame(() => {
      overlay.classList.add('visible');
      panel.classList.add('open');
    });
  }

  function closeFormPanel() {
    const overlay = document.getElementById('formOverlay');
    const panel = document.getElementById('formPanel');
    panel.classList.remove('open');
    overlay.classList.remove('visible');
    setTimeout(() => { overlay.style.display = 'none'; }, 300);
    editingEntryId = null;
  }

  function openAddForm() {
    editingEntryId = null;
    document.getElementById('formTitle').textContent = 'Add Color Entry';
    document.getElementById('entryType').value = 'SolidColor';
    document.getElementById('entryValue').value = '';
    document.getElementById('startColor').value = '#ffffff';
    document.getElementById('startAlpha').value = '1';
    document.getElementById('endColor').value = '#ffffff';
    document.getElementById('endAlpha').value = '1';
    toggleEntryFields();
    openFormPanel();
  }

  function openEditForm(id) {
    const entry = colorEntries.find(e => e.id === id);
    if (!entry) return;
    editingEntryId = id;
    document.getElementById('formTitle').textContent = 'Edit Color Entry';
    document.getElementById('entryType').value = entry.type;
    document.getElementById('entryValue').value = entry.value;
    document.getElementById('startColor').value = entry.startColor;
    document.getElementById('startAlpha').value = entry.alpha;
    document.getElementById('endColor').value = entry.endColor || '#ffffff';
    document.getElementById('endAlpha').value = entry.endAlpha || '1';
    toggleEntryFields();
    openFormPanel();
  }

  function cancelEdit() {
    closeFormPanel();
  }

  function toggleEntryFields() {
    const type = document.getElementById('entryType').value;
    document.getElementById('startAlphaGroup').style.display = type.endsWith('4') ? '' : 'none';
    document.getElementById('endColorGroup').style.display = type.startsWith('Color') ? '' : 'none';
    document.getElementById('endAlphaGroup').style.display = (type === 'Color4') ? '' : 'none';
  }

  // ‚îÄ‚îÄ State Management ‚îÄ‚îÄ
  function saveState() {
    undoStack.push({
      colorEntries: JSON.parse(JSON.stringify(colorEntries)),
      settings: {
        product: document.getElementById('product').value,
        units: document.getElementById('units').value,
        scale: document.getElementById('scale').value,
        offset: document.getElementById('offset').value,
        step: document.getElementById('step').value,
        rfColor: document.getElementById('rfColor').value,
        filename: document.getElementById('filename').value,
        darkMode: isDarkMode
      }
    });
  }

  function undo() {
    if (undoStack.length > 0) {
      const prev = undoStack.pop();
      colorEntries = prev.colorEntries;
      document.getElementById('product').value = prev.settings.product;
      document.getElementById('units').value = prev.settings.units;
      document.getElementById('scale').value = prev.settings.scale;
      document.getElementById('offset').value = prev.settings.offset;
      document.getElementById('step').value = prev.settings.step;
      document.getElementById('rfColor').value = prev.settings.rfColor;
      document.getElementById('filename').value = prev.settings.filename;
      if (prev.settings.darkMode !== isDarkMode) toggleDarkMode();
      renderEntries();
      updatePreview();
      showToast('Undone', 'info');
    } else {
      showToast('Nothing to undo', 'info');
    }
  }

  // Ctrl+Z undo
  document.addEventListener('keydown', function(e) {
    if ((e.ctrlKey || e.metaKey) && e.key === 'z') {
      // Don't intercept if user is typing in an input/select
      if (e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT' || e.target.tagName === 'TEXTAREA') return;
      e.preventDefault();
      undo();
    }
  });

  // ‚îÄ‚îÄ Save / Edit Entry ‚îÄ‚îÄ
  function saveEntry() {
    const type = document.getElementById('entryType').value;
    const value = parseFloat(document.getElementById('entryValue').value);
    const startColor = document.getElementById('startColor').value;
    const alpha = type.endsWith('4') ? parseFloat(document.getElementById('startAlpha').value) : 1;
    const endColor = type.startsWith('Color') ? document.getElementById('endColor').value : null;
    const endAlpha = (type === 'Color4') ? parseFloat(document.getElementById('endAlpha').value) : 1;

    if (isNaN(value)) { showToast('Please enter a valid value.', 'error'); return; }
    if (type.endsWith('4') && (isNaN(alpha) || alpha < 0 || alpha > 1)) {
      showToast('Start Alpha must be between 0 and 1.', 'error'); return;
    }
    if (type === 'Color4' && (isNaN(endAlpha) || endAlpha < 0 || endAlpha > 1)) {
      showToast('End Alpha must be between 0 and 1.', 'error'); return;
    }

    saveState();

    if (editingEntryId !== null) {
      const idx = colorEntries.findIndex(e => e.id === editingEntryId);
      if (idx !== -1) {
        colorEntries[idx] = { id: editingEntryId, type, value, startColor, alpha, endColor, endAlpha };
      }
      showToast('Entry updated', 'success');
    } else {
      const newId = colorEntries.length > 0 ? Math.max(...colorEntries.map(e => e.id)) + 1 : 0;
      colorEntries.push({ id: newId, type, value, startColor, alpha, endColor, endAlpha });
      showToast('Entry added', 'success');
    }

    renderEntries();
    updatePreview();
    closeFormPanel();
  }

  // ‚îÄ‚îÄ Entry Operations ‚îÄ‚îÄ
  function duplicateEntry(id) {
    saveState();
    const entry = colorEntries.find(e => e.id === id);
    if (!entry) return;
    const newId = colorEntries.length > 0 ? Math.max(...colorEntries.map(e => e.id)) + 1 : 0;
    colorEntries.push({ ...entry, id: newId });
    renderEntries();
    updatePreview();
    showToast('Entry duplicated', 'success');
  }

  function removeEntry(id) {
    saveState();
    const entryDiv = document.querySelector(`.color-entry[data-id='${id}']`);
    if (entryDiv) {
      entryDiv.style.transition = 'opacity 0.3s, transform 0.3s';
      entryDiv.style.opacity = '0';
      entryDiv.style.transform = 'translateX(-20px)';
      setTimeout(() => {
        colorEntries = colorEntries.filter(e => e.id !== id);
        renderEntries();
        updatePreview();
        showToast('Entry removed', 'info');
      }, 300);
    } else {
      colorEntries = colorEntries.filter(e => e.id !== id);
      renderEntries();
      updatePreview();
    }
  }

  function sortEntries() {
    saveState();
    colorEntries.sort((a, b) => a.value - b.value);
    renderEntries();
    updatePreview();
    showToast('Sorted by value', 'info');
  }

  // ‚îÄ‚îÄ Drag and Drop ‚îÄ‚îÄ
  function setupDragAndDrop(entryDiv, entry) {
    const handle = entryDiv.querySelector('.drag-handle');

    handle.addEventListener('mousedown', () => {
      entryDiv.setAttribute('draggable', 'true');
    });

    handle.addEventListener('mouseup', () => {
      entryDiv.setAttribute('draggable', 'false');
    });

    entryDiv.addEventListener('dragstart', (e) => {
      draggedEntryId = entry.id;
      entryDiv.classList.add('dragging');
      e.dataTransfer.effectAllowed = 'move';
      e.dataTransfer.setData('text/plain', entry.id.toString());
    });

    entryDiv.addEventListener('dragover', (e) => {
      e.preventDefault();
      e.dataTransfer.dropEffect = 'move';
      if (entry.id === draggedEntryId) return;

      // Clear all other indicators
      document.querySelectorAll('.drag-over-top, .drag-over-bottom').forEach(el => {
        el.classList.remove('drag-over-top', 'drag-over-bottom');
      });

      const rect = entryDiv.getBoundingClientRect();
      const midY = rect.top + rect.height / 2;
      if (e.clientY < midY) {
        entryDiv.classList.add('drag-over-top');
      } else {
        entryDiv.classList.add('drag-over-bottom');
      }
    });

    entryDiv.addEventListener('dragleave', () => {
      entryDiv.classList.remove('drag-over-top', 'drag-over-bottom');
    });

    entryDiv.addEventListener('drop', (e) => {
      e.preventDefault();
      if (entry.id === draggedEntryId) return;

      saveState();

      const isAbove = entryDiv.classList.contains('drag-over-top');
      const srcIdx = colorEntries.findIndex(x => x.id === draggedEntryId);
      const [moved] = colorEntries.splice(srcIdx, 1);
      let tgtIdx = colorEntries.findIndex(x => x.id === entry.id);
      if (!isAbove) tgtIdx++;
      colorEntries.splice(tgtIdx, 0, moved);

      renderEntries();
      updatePreview();
      showToast('Entry moved', 'info');
    });

    entryDiv.addEventListener('dragend', () => {
      entryDiv.classList.remove('dragging');
      entryDiv.setAttribute('draggable', 'false');
      document.querySelectorAll('.drag-over-top, .drag-over-bottom').forEach(el => {
        el.classList.remove('drag-over-top', 'drag-over-bottom');
      });
      draggedEntryId = null;
    });
  }

  // ‚îÄ‚îÄ Render Entries ‚îÄ‚îÄ
  function renderEntries() {
    const container = document.getElementById('entriesContainer');
    container.innerHTML = '';

    // NOTE: No auto-sort here ‚Äî entries stay in user-defined order.
    // Use "Sort by Value" button for explicit sorting.

    document.getElementById('entriesCount').textContent = `${colorEntries.length} entr${colorEntries.length === 1 ? 'y' : 'ies'}`;

    if (colorEntries.length === 0) {
      container.innerHTML = `
        <div class="entries-empty">
          <div class="empty-icon">üé®</div>
          <p>No color entries yet.<br>Click <strong>Add Color</strong> to get started, or <strong>Load</strong> an existing file.</p>
        </div>`;
      return;
    }

    colorEntries.forEach(entry => {
      const el = document.createElement('div');
      el.className = 'color-entry';
      el.setAttribute('data-id', entry.id);

      // Color bar on left
      const bar = document.createElement('div');
      bar.className = 'entry-color-bar';
      bar.style.background = entry.endColor
        ? `linear-gradient(to bottom, ${entry.startColor}, ${entry.endColor})`
        : entry.startColor;
      el.appendChild(bar);

      // Drag handle
      const handle = document.createElement('div');
      handle.className = 'drag-handle';
      handle.innerHTML = '‚†ø';
      handle.title = 'Drag to reorder';
      el.appendChild(handle);

      // Info section
      const info = document.createElement('div');
      info.className = 'entry-info';

      // Type badge
      const badge = document.createElement('span');
      badge.className = 'entry-type-badge';
      badge.textContent = entry.type;
      info.appendChild(badge);

      // Value input
      const valField = document.createElement('div');
      valField.className = 'entry-field';
      const valLabel = document.createElement('label');
      valLabel.textContent = 'Val';
      const valInput = document.createElement('input');
      valInput.type = 'number';
      valInput.step = '1';
      valInput.value = entry.value;
      valInput.onchange = function() {
        saveState();
        entry.value = parseFloat(this.value);
        updatePreview();
      };
      valField.appendChild(valLabel);
      valField.appendChild(valInput);
      info.appendChild(valField);

      // Start color swatch
      const startField = document.createElement('div');
      startField.className = 'entry-field';
      const startLabel = document.createElement('label');
      startLabel.textContent = 'Start';
      const startInput = document.createElement('input');
      startInput.type = 'color';
      startInput.value = entry.startColor;
      startInput.title = `RGB: ${hexToRgb(entry.startColor).r}, ${hexToRgb(entry.startColor).g}, ${hexToRgb(entry.startColor).b}`;
      startInput.oninput = function() {
        entry.startColor = this.value;
        bar.style.background = entry.endColor
          ? `linear-gradient(to bottom, ${entry.startColor}, ${entry.endColor})`
          : entry.startColor;
        updatePreview();
      };
      startInput.onchange = function() { saveState(); };
      startField.appendChild(startLabel);
      startField.appendChild(startInput);
      info.appendChild(startField);

      // Start alpha
      if (entry.type.endsWith('4')) {
        const alphaField = document.createElement('div');
        alphaField.className = 'entry-field';
        const aLabel = document.createElement('label');
        aLabel.textContent = 'Œ±';
        const aInput = document.createElement('input');
        aInput.type = 'number';
        aInput.step = '0.01';
        aInput.min = '0';
        aInput.max = '1';
        aInput.value = entry.alpha;
        aInput.style.width = '52px';
        aInput.onchange = function() {
          saveState();
          entry.alpha = parseFloat(this.value);
          updatePreview();
        };
        alphaField.appendChild(aLabel);
        alphaField.appendChild(aInput);
        info.appendChild(alphaField);
      }

      // End color
      if (entry.endColor) {
        const endField = document.createElement('div');
        endField.className = 'entry-field';
        const endLabel = document.createElement('label');
        endLabel.textContent = 'End';
        const endInput = document.createElement('input');
        endInput.type = 'color';
        endInput.value = entry.endColor;
        endInput.title = `RGB: ${hexToRgb(entry.endColor).r}, ${hexToRgb(entry.endColor).g}, ${hexToRgb(entry.endColor).b}`;
        endInput.oninput = function() {
          entry.endColor = this.value;
          bar.style.background = `linear-gradient(to bottom, ${entry.startColor}, ${entry.endColor})`;
          updatePreview();
        };
        endInput.onchange = function() { saveState(); };
        endField.appendChild(endLabel);
        endField.appendChild(endInput);
        info.appendChild(endField);

        // Gradient preview chip
        const gradPreview = document.createElement('div');
        gradPreview.className = 'entry-gradient-preview';
        gradPreview.style.background = `linear-gradient(to right, ${entry.startColor}, ${entry.endColor})`;
        info.appendChild(gradPreview);

        // End alpha
        if (entry.type.endsWith('4')) {
          const eaField = document.createElement('div');
          eaField.className = 'entry-field';
          const eaLabel = document.createElement('label');
          eaLabel.textContent = 'Œ±‚ÇÇ';
          const eaInput = document.createElement('input');
          eaInput.type = 'number';
          eaInput.step = '0.01';
          eaInput.min = '0';
          eaInput.max = '1';
          eaInput.value = entry.endAlpha;
          eaInput.style.width = '52px';
          eaInput.onchange = function() {
            saveState();
            entry.endAlpha = parseFloat(this.value);
            updatePreview();
          };
          eaField.appendChild(eaLabel);
          eaField.appendChild(eaInput);
          info.appendChild(eaField);
        }
      }

      el.appendChild(info);

      // Action buttons
      const actions = document.createElement('div');
      actions.className = 'entry-actions';

      const editBtn = document.createElement('button');
      editBtn.className = 'btn btn-icon btn-ghost';
      editBtn.innerHTML = '‚úèÔ∏è';
      editBtn.title = 'Edit';
      editBtn.onclick = (e) => { e.stopPropagation(); openEditForm(entry.id); };
      actions.appendChild(editBtn);

      const dupBtn = document.createElement('button');
      dupBtn.className = 'btn btn-icon btn-ghost';
      dupBtn.innerHTML = 'üìã';
      dupBtn.title = 'Duplicate';
      dupBtn.onclick = (e) => { e.stopPropagation(); duplicateEntry(entry.id); };
      actions.appendChild(dupBtn);

      const delBtn = document.createElement('button');
      delBtn.className = 'btn btn-icon btn-ghost';
      delBtn.innerHTML = 'üóëÔ∏è';
      delBtn.title = 'Remove';
      delBtn.style.color = 'var(--danger)';
      delBtn.onclick = (e) => { e.stopPropagation(); removeEntry(entry.id); };
      actions.appendChild(delBtn);

      el.appendChild(actions);

      // Hover ‚Üí highlight preview segment
      el.addEventListener('mouseover', () => highlightPreviewSegment(entry));
      el.addEventListener('mouseout', () => updatePreview());

      // Setup drag and drop
      setupDragAndDrop(el, entry);

      container.appendChild(el);
    });
  }

  // ‚îÄ‚îÄ Preview ‚îÄ‚îÄ
  function highlightPreviewSegment(entry) {
    const canvas = document.getElementById('previewCanvas');
    const ctx = canvas.getContext('2d');
    const width = canvas.width;
    const height = canvas.height;

    updatePreview();

    const sorted = [...colorEntries].sort((a, b) => a.value - b.value);
    if (sorted.length < 1) return;
    const minVal = sorted[0].value;
    const maxVal = sorted[sorted.length - 1].value;
    const range = maxVal - minVal || 1;

    const idx = sorted.findIndex(e => e.id === entry.id);
    if (idx === -1) return;
    const xPos = ((sorted[idx].value - minVal) / range) * width;
    const nextXPos = idx < sorted.length - 1
      ? ((sorted[idx + 1].value - minVal) / range) * width
      : width;

    ctx.fillStyle = 'rgba(255, 255, 255, 0.35)';
    ctx.fillRect(xPos, 0, nextXPos - xPos, height);

    // Draw highlight border
    ctx.strokeStyle = 'rgba(99, 102, 241, 0.8)';
    ctx.lineWidth = 2;
    ctx.strokeRect(xPos + 1, 1, (nextXPos - xPos) - 2, height - 2);
  }

  function updatePreview() {
    const canvas = document.getElementById('previewCanvas');
    const ctx = canvas.getContext('2d');
    const width = canvas.width = canvas.offsetWidth;
    const height = canvas.height = canvas.offsetHeight;
    ctx.clearRect(0, 0, width, height);

    const markersContainer = document.getElementById('markersContainer');
    markersContainer.innerHTML = '';

    if (colorEntries.length === 0) {
      // Draw empty state
      ctx.fillStyle = 'var(--bg-input)';
      ctx.fillRect(0, 0, width, height);
      return;
    }

    // Always sort a copy for preview rendering
    const sorted = [...colorEntries].sort((a, b) => a.value - b.value);
    const minVal = sorted[0].value;
    const maxVal = sorted[sorted.length - 1].value;
    const range = maxVal - minVal || 1;

    sorted.forEach((entry, index) => {
      let xPos = ((entry.value - minVal) / range) * width;
      let nextXPos = index < sorted.length - 1
        ? ((sorted[index + 1].value - minVal) / range) * width
        : width;

      xPos = Math.max(0, Math.min(width, xPos));
      nextXPos = Math.max(0, Math.min(width, nextXPos));

      let segWidth = nextXPos - xPos;
      if (segWidth < 1) {
        segWidth = 1;
        if (nextXPos < width) nextXPos = xPos + segWidth;
        else xPos = nextXPos - segWidth;
      }

      let fill;
      if (entry.endColor) {
        fill = ctx.createLinearGradient(xPos, 0, nextXPos, 0);
        fill.addColorStop(0, rgbaColor(entry.startColor, entry.alpha));
        fill.addColorStop(1, rgbaColor(entry.endColor, entry.endAlpha));
      } else if (index < sorted.length - 1) {
        const next = sorted[index + 1];
        fill = ctx.createLinearGradient(xPos, 0, nextXPos, 0);
        fill.addColorStop(0, rgbaColor(entry.startColor, entry.alpha));
        fill.addColorStop(1, rgbaColor(next.startColor, next.alpha));
      } else {
        fill = rgbaColor(entry.startColor, entry.alpha);
      }
      ctx.fillStyle = fill;
      ctx.fillRect(xPos, 0, segWidth, height);

      // Markers
      addValueMarker(entry.value, xPos, width);
    });

    // RF color overlay
    const rfColor = document.getElementById('rfColor').value;
    ctx.fillStyle = rgbaColor(rfColor, 0.3);
    ctx.fillRect(0, 0, width, height);
  }

  function addValueMarker(value, xPos, canvasWidth) {
    const markersContainer = document.getElementById('markersContainer');
    const minDist = 50;
    const last = markersContainer.lastElementChild;
    if (last && Math.abs(xPos - parseFloat(last.style.left)) < minDist) return;

    const div = document.createElement('div');
    div.className = 'marker';
    div.style.left = `${xPos}px`;
    div.textContent = value;
    markersContainer.appendChild(div);
  }

  // ‚îÄ‚îÄ Preview Click ‚Üí scroll to entry ‚îÄ‚îÄ
  document.getElementById('previewCanvas').addEventListener('click', function(event) {
    const canvas = this;
    const rect = canvas.getBoundingClientRect();
    const x = event.clientX - rect.left;

    const sorted = [...colorEntries].sort((a, b) => a.value - b.value);
    if (sorted.length === 0) return;
    const minVal = sorted[0].value;
    const maxVal = sorted[sorted.length - 1].value;
    const width = canvas.width;
    const range = maxVal - minVal || 1;

    let clicked = null;
    sorted.some((entry, index) => {
      const ex = ((entry.value - minVal) / range) * width;
      const nx = index < sorted.length - 1
        ? ((sorted[index + 1].value - minVal) / range) * width
        : width;
      if (x >= ex && x <= nx) { clicked = entry; return true; }
      return false;
    });

    if (clicked) {
      const el = document.querySelector(`.color-entry[data-id="${clicked.id}"]`);
      if (el) {
        document.querySelectorAll('.highlight-entry').forEach(e => e.classList.remove('highlight-entry'));
        el.scrollIntoView({ behavior: 'smooth', block: 'center' });
        el.classList.add('highlight-entry');
        setTimeout(() => el.classList.remove('highlight-entry'), 1500);
      }
    }
  });

  // ‚îÄ‚îÄ Utility ‚îÄ‚îÄ
  function rgbaColor(hex, alpha) {
    const bigint = parseInt(hex.slice(1), 16);
    return `rgba(${(bigint >> 16) & 255}, ${(bigint >> 8) & 255}, ${bigint & 255}, ${alpha})`;
  }

  function hexToRgb(hex) {
    const bigint = parseInt(hex.slice(1), 16);
    return { r: (bigint >> 16) & 255, g: (bigint >> 8) & 255, b: bigint & 255 };
  }

  // ‚îÄ‚îÄ Save Color Table ‚îÄ‚îÄ
  function saveColorTable() {
    if (colorEntries.length === 0) {
      showToast('No entries to save.', 'error');
      return;
    }
    const content = generatePalContent();
    const blob = new Blob([content], { type: 'text/plain' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = document.getElementById('filename').value || 'color_table.pal';
    link.click();
    showToast('Color table saved!', 'success');
  }

  function generatePalContent() {
    let lines = [];
    lines.push('; Generated Color Table with Tools by Garrett Helms for WxTools.org');

    const product = document.getElementById('product').value;
    const units = document.getElementById('units').value;
    const scale = document.getElementById('scale').value;
    const offset = document.getElementById('offset').value;
    const step = document.getElementById('step').value;
    const rfColor = document.getElementById('rfColor').value;

    if (product) lines.push(`Product: ${product}`);
    if (units) lines.push(`Units: ${units}`);
    if (scale) lines.push(`Scale: ${scale}`);
    if (offset) lines.push(`Offset: ${offset}`);
    if (step) lines.push(`Step: ${step}`);
    if (rfColor) {
      const rf = hexToRgb(rfColor);
      lines.push(`RF: ${rf.r} ${rf.g} ${rf.b}`);
    }

    lines.push('');

    // Sort entries by value for output
    const sorted = [...colorEntries].sort((a, b) => a.value - b.value);
    sorted.forEach(entry => {
      const s = hexToRgb(entry.startColor);
      let line = `${entry.type}: ${entry.value} ${s.r} ${s.g} ${s.b}`;
      if (entry.type.endsWith('4')) line += ` ${entry.alpha}`;
      if (entry.endColor) {
        const e = hexToRgb(entry.endColor);
        line += ` ${e.r} ${e.g} ${e.b}`;
        if (entry.type.endsWith('4')) line += ` ${entry.endAlpha}`;
      }
      lines.push(line);
    });

    return lines.join('\n');
  }

  // ‚îÄ‚îÄ Load Color Table ‚îÄ‚îÄ
  function loadColorTable() {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.pal,.txt';
    input.onchange = (event) => {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = (e) => {
        if (file.name.endsWith('.pal') || file.name.endsWith('.txt')) {
          saveState();
          loadFromPalData(e.target.result);
          showToast(`Loaded ${file.name}`, 'success');
        } else {
          showToast('Unsupported file format.', 'error');
        }
      };
      reader.readAsText(file);
    };
    input.click();
  }

  function loadFromPalData(content) {
    colorEntries = [];
    document.getElementById('product').value = '';
    document.getElementById('units').value = '';
    document.getElementById('scale').value = '';
    document.getElementById('offset').value = '';
    document.getElementById('step').value = '';
    document.getElementById('rfColor').value = '#404040';

    const lines = content.split('\n').map(l => l.trim()).filter(l => l);

    lines.forEach((line, index) => {
      line = line.split(';')[0].split('//')[0].trim();
      if (!line) return;

      try {
        if (/^Product:/i.test(line)) {
          document.getElementById('product').value = line.split(':')[1].trim();
        } else if (/^Units:/i.test(line)) {
          document.getElementById('units').value = line.split(':')[1].trim();
        } else if (/^Scale:/i.test(line)) {
          document.getElementById('scale').value = parseFloat(line.split(':')[1].trim());
        } else if (/^Offset:/i.test(line)) {
          document.getElementById('offset').value = parseFloat(line.split(':')[1].trim());
        } else if (/^Step:/i.test(line)) {
          document.getElementById('step').value = parseFloat(line.split(':')[1].trim());
        } else if (/^RF:/i.test(line)) {
          const rgb = line.split(':')[1].trim().split(/\s+/).map(Number);
          if (rgb.length >= 3 && rgb.every(n => !isNaN(n) && n >= 0 && n <= 255)) {
            document.getElementById('rfColor').value = `#${((1 << 24) | (rgb[0] << 16) | (rgb[1] << 8) | rgb[2]).toString(16).slice(1).toUpperCase()}`;
          } else {
            showToast(`Invalid RF color on line ${index + 1}`, 'error');
          }
        } else if (/^(SolidColor4|SolidColor|Color4|Color):/i.test(line) || /^[0-9]/.test(line)) {
          parseColorLine(line, index + 1);
        }
      } catch (error) {
        showToast(`Error on line ${index + 1}: ${error.message}`, 'error');
      }
    });

    renderEntries();
    updatePreview();
  }

  function parseColorLine(line, lineNumber) {
    line = line.split(';')[0].split('//')[0].trim();

    let typeMatch = line.match(/^(SolidColor4|SolidColor|Color4|Color):/i);
    let type = typeMatch ? typeMatch[1] : null;
    let contentPart = typeMatch ? line.slice(typeMatch[0].length).trim() : line.trim();
    const tokens = contentPart.split(/\s+/).map(t => t.trim());

    if (type) {
      type = type.charAt(0).toUpperCase() + type.slice(1).toLowerCase();
      // Fix casing for known types
      if (type === 'Solidcolor') type = 'SolidColor';
      if (type === 'Solidcolor4') type = 'SolidColor4';
      if (type === 'Color4') type = 'Color4';
    }

    let hasAlpha = false;
    if (type) {
      hasAlpha = type.endsWith('4');
    } else {
      hasAlpha = (tokens.length === 5 || tokens.length === 9);
    }

    const colorValueCount = hasAlpha ? 4 : 3;
    const isGradient = tokens.length === (1 + colorValueCount * 2);

    if (!type) {
      type = isGradient
        ? (hasAlpha ? 'Color4' : 'Color')
        : (hasAlpha ? 'SolidColor4' : 'SolidColor');
    }

    const value = parseFloat(tokens[0]);
    const r1 = parseInt(tokens[1]), g1 = parseInt(tokens[2]), b1 = parseInt(tokens[3]);
    const a1 = hasAlpha ? parseFloat(tokens[4]) : 1;

    let r2, g2, b2, a2 = 1;
    if (isGradient) {
      const idx = 1 + colorValueCount;
      r2 = parseInt(tokens[idx]);
      g2 = parseInt(tokens[idx + 1]);
      b2 = parseInt(tokens[idx + 2]);
      if (hasAlpha) a2 = parseFloat(tokens[idx + 3]);
    }

    if (isNaN(value) || isNaN(r1) || isNaN(g1) || isNaN(b1) || (hasAlpha && isNaN(a1))) {
      throw new Error(`Invalid values on line ${lineNumber}.`);
    }
    if (isGradient && (isNaN(r2) || isNaN(g2) || isNaN(b2) || (hasAlpha && isNaN(a2)))) {
      throw new Error(`Invalid gradient values on line ${lineNumber}.`);
    }

    const startColor = `#${((1 << 24) | (r1 << 16) | (g1 << 8) | b1).toString(16).slice(1).toUpperCase()}`;
    const endColor = isGradient
      ? `#${((1 << 24) | (r2 << 16) | (g2 << 8) | b2).toString(16).slice(1).toUpperCase()}`
      : null;

    const newId = colorEntries.length > 0 ? Math.max(...colorEntries.map(e => e.id)) + 1 : 0;
    colorEntries.push({
      id: newId,
      type,
      value,
      startColor,
      alpha: hasAlpha ? a1 : 1,
      endColor,
      endAlpha: isGradient && hasAlpha ? a2 : 1
    });
  }

  // ‚îÄ‚îÄ Event Listeners ‚îÄ‚îÄ
  document.getElementById('rfColor').addEventListener('input', () => {
    updatePreview();
  });
  document.getElementById('rfColor').addEventListener('change', saveState);

  ['product', 'units', 'scale', 'offset', 'step', 'filename'].forEach(id => {
    document.getElementById(id).addEventListener('change', saveState);
  });

  // ‚îÄ‚îÄ Initial Render ‚îÄ‚îÄ
  renderEntries();
  updatePreview();
  saveState();
</script>
</body>
</html>
